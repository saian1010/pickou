{% extends "userbase.html" %}
{% set active_page = 'home' %}
{% block title %}{{ post.title }}{% endblock %}

{% block head %}
{{ super() }}
<!-- 使用本地static目录中的Swiper资源 -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/swiper-bundle.min.css') }}" />
<script src="{{ url_for('static', filename='js/swiper-bundle.min.js') }}"></script>
<style>
    /* 修复额外的Swiper样式问题 */
    .swiper-wrapper {
        display: flex;
        transition-property: transform;
    }
    
    /* 确保Swiper容器正确垂直居中内容 */
    .swiper, .swiper-wrapper {
        height: auto !important;
        width: 100% !important;
    }
    
    .swiper-slide {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100% !important;
        background-color: white;
        padding: 0;
    }
    
    .swiper-slide img {
        width: 100%;
        height: auto;
        max-height: 90vh;
        object-fit: cover;
        margin: 0;
        padding: 0;
    }

    /* 设置页面背景为白色 */
    .post-detail-container {
        background-color: white !important;
        max-width: 100% !important;
        padding: 0 !important;
        overflow-x: hidden;
        width: 100% !important;
        box-sizing: border-box;
    }

    /* 用户信息区域样式 */
    .post-user-info {
        width: 100% !important;
        padding: 15px 20px;
        background-color: white;
        position: relative;
        z-index: 10;
        box-sizing: border-box;
    }

    .post-card {
        margin: 0;
        border-radius: 0;
        padding: 0;
        width: 100%;
        box-shadow: none;
        background-color: white;
    }

    /* 图片区域样式 */
    .post-images-wrapper {
        width: 100%;
        margin-bottom: 0;
        position: relative;
        overflow: hidden;
        background-color: white;
        padding: 0;
    }
    
    .post-swiper {
        width: 100% !important;
        height: auto !important;
        margin: 0;
        padding: 0;
    }
    
    /* 确保内容区域有合适的边距 */
    .post-content {
        padding: 0;
        width: 100%;
        box-sizing: border-box;
        margin: 0;
    }

    /* 标题和文字内容区域样式 */
    .post-title, .post-text {
        padding: 15px 20px;
        width: 100%;
        box-sizing: border-box;
        margin-left: 0;
        margin-right: 0;
    }
    
    /* 评论区样式调整 */
    .comments-section {
        margin: 20px 0 0 0;
        border-radius: 0;
        width: 100%;
        padding: 20px;
        box-shadow: none;
        box-sizing: border-box;
    }

    /* 返回按钮样式 */
    .back-link {
        position: fixed;
        top: 10px;
        left: 10px;
        z-index: 1000;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 20px;
        padding: 5px 15px;
    }

    /* 投票区域样式 */
    .vote-section {
        margin: 15px 20px !important;
        width: calc(100% - 40px) !important;
        box-sizing: border-box;
        border-radius: 10px !important;
    }

    /* 覆盖bootstrap容器样式 */
    .container {
        max-width: 100% !important;
        padding-left: 0 !important;
        padding-right: 0 !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
        width: 100% !important;
    }
    
    .swiper-pagination {
        position: absolute;
        bottom: 10px;
    }
    
    .swiper-pagination-bullet {
        width: 8px;
        height: 8px;
        background: #a4a2a2;
        opacity: 0.6;
    }
    
    .swiper-pagination-bullet-active {
        background: #ff2442;
        opacity: 1;
    }
    
    .swiper-button-next,
    .swiper-button-prev {
        color: white;
        background: rgba(0, 0, 0, 0.44);
        width: 32px;
        height: 32px;
        border-radius: 50%;
        --swiper-navigation-size: 18px;
    }
    
    .swiper-button-next:after,
    .swiper-button-prev:after {
        font-size: 16px;
        font-weight: bold;
    }
    
    .image-counter {
        position: absolute;
        bottom: 10px;
        right: 10px;
        background: rgba(0, 0, 0, 0.5);
        color: white;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        z-index: 10;
    }
    
    .swiper-wrapper {
        align-items: stretch;
    }
    
    .swiper-slide {
        opacity: 1 !important;
        visibility: visible !important;
        transition: transform 0.3s ease;
        height: auto;
    }
    
    .swiper-lazy-preloader {
        border-color: #ff2442;
    }
</style>
{% endblock %}

{% block content %}
<div class="container post-detail-container">
    <!-- 返回按钮 -->
    <div class="back-link mb-3 mt-3">
        <a href="{{ url_for('visitor_home') }}" class="text-decoration-none">
            <i class="bi bi-arrow-left"></i> Back
        </a>
    </div>
    
    <!-- 帖子内容卡片 -->
    <div class="post-card">
        <!-- 用户信息区域 -->
        <div class="post-user-info d-flex justify-content-between align-items-center mb-3">
            <div class="d-flex align-items-center">
                <!-- 用户头像 -->
                {% if post.profile_image %}
                    <img src="{{ url_for('get_profile_image', filename=post.profile_image) }}" class="user-avatar" alt="{{ post.username }}">
                {% else %}
                    <div class="user-avatar-placeholder">
                        {{ post.username[0]|upper }}
                    </div>
                {% endif %}
                
                <!-- 用户名 -->
                <div class="ms-2">
                    <div class="username">{{ post.username }}</div>
                    <div class="post-time">{{ post.created_at.strftime('%Y-%m-%d %H:%M') }}</div>
                </div>
            </div>
            
            <!-- 关注按钮和分享图标 -->
            <div class="d-flex align-items-center">
                {% if not is_author and 'loggedin' in session %}
                    <button class="btn follow-btn {% if is_following %}followed{% endif %}" data-user-id="{{ post.author_id }}">
                        {% if is_following %}
                            <i class="bi bi-check"></i> Following
                        {% else %}
                            <i class="bi bi-plus"></i> Follow
                        {% endif %}
                    </button>
                {% endif %}
                <button class="btn share-btn ms-2">
                    <i class="bi bi-share"></i>
                </button>
            </div>
        </div>
        
        <!-- 帖子内容区域 -->
        <div class="post-content">
            <!-- 图片区域 (如果有图片) -->
            {% if images %}
            <div class="post-images-wrapper">
                <!-- Swiper -->
                <div class="swiper post-swiper">
                    <div class="swiper-wrapper">
                        {% for image in images %}
                        <div class="swiper-slide">
                            <img src="{{ url_for('get_post_image', filename=image.image_path) }}" 
                                 alt="Post image {{ loop.index }}"
                                 data-bs-toggle="modal"
                                 data-bs-target="#imageModal"
                                 data-bs-img="{{ url_for('get_post_image', filename=image.image_path) }}"
                                 class="swiper-lazy">
                            <div class="swiper-lazy-preloader"></div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <!-- 分页器 -->
                    <div class="swiper-pagination"></div>
            
                </div>
                
                <!-- 图片数量指示器 -->
                <div class="image-counter">
                    <span class="current-index">1</span>/<span class="total-images">{{ images|length }}</span>
                </div>
            </div>
            {% endif %}
            
            <!-- 标题和内容 -->
            <h4 class="post-title mb-3" style="word-break: break-word; max-width: 100%;">{{ post.title }}</h4>
            <div class="post-text whitespace-pre-wrap mb-4" style="word-break: break-word; max-width: 100%;" id="post-content">{{ post.content }}</div>
            
            <!-- 投票区域 (如果有投票) -->
            {% if vote_data %}
                <div class="vote-section mt-4 mb-4">
                    <!-- <h5 class="vote-title mb-3">{{ vote_data.vote.vote_title }}</h5> -->
                    <div id="vote-alert" class="alert alert-dismissible fade" role="alert" style="display: none;">
                        <span id="vote-alert-message"></span>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                    
                    {% if vote_data.options|length == 2 %}
                        <!-- PK样式投票 (两个选项) -->
                        <div class="pk-vote-container">
                            <div class="pk-options-row">
                                {% for option in vote_data.options %}
                                    {% set percent = ((option.vote_count / vote_data.total_votes) * 100)|int if vote_data.total_votes > 0 else 50 %}
                                    <div class="pk-option {% if vote_data.has_voted and option.vote_option_id in vote_data.user_voted_options %}selected{% endif %}"
                                         data-option-id="{{ option.vote_option_id }}">
                                        <div class="pk-option-content">
                                            <div class="pk-option-title">{{ option.title }}</div>
                                            <div class="pk-option-percent" {% if not vote_data.has_voted %}style="display:none"{% endif %}>
                                                {{ percent }}%
                                            </div>
                                            <div class="pk-vote-count" {% if not vote_data.has_voted %}style="display:none"{% endif %}>
                                                ({{ option.vote_count }} votes)
                                            </div>
                                        </div>
                                        <div class="pk-option-bar" style="width: {% if vote_data.has_voted %}{{ percent }}{% else %}0{% endif %}%"></div>
                                    </div>
                                    
                                    {% if loop.first %}
                                        <div class="pk-vs">VS</div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            
                            {% if 'loggedin' in session and not vote_data.has_voted %}
                                <form id="pkVoteForm" class="text-center mt-3">
                                    <input type="hidden" name="option" id="pk-selected-option">
                                    <input type="hidden" name="post_id" value="{{ post.post_id }}">
                                    <button type="button" class="btn vote-btn" id="pk-vote-btn" disabled>Vote</button>
                                </form>
                            {% endif %}
                        </div>
                    {% else %}
                        <!-- 常规样式投票 (三个或更多选项) -->
                        <div class="normal-vote-container">
                            <div id="vote-results" class="vote-results" {% if not vote_data.has_voted %}style="display:none"{% endif %}>
                                {% for option in vote_data.options %}
                                    {% set percent = ((option.vote_count / vote_data.total_votes) * 100)|int if vote_data.total_votes > 0 else 0 %}
                                    <div class="vote-result-item {% if option.vote_option_id in vote_data.user_voted_options %}selected{% endif %}">
                                        <div class="d-flex justify-content-between mb-1">
                                            <div class="vote-option-title">{{ option.title }}</div>
                                            <div class="vote-percent">{{ percent }}% ({{ option.vote_count }} votes)</div>
                                        </div>
                                        <div class="progress">
                                            <div class="progress-bar" role="progressbar" style="width: {{ percent }}%"></div>
                                        </div>
                                    </div>
                                {% endfor %}
                                <div class="vote-total text-center mt-3">
                                    <small>Total <span id="total-vote-count">{{ vote_data.total_votes }}</span> voters</small>
                                </div>
                            </div>
                            
                            <form id="normalVoteForm" class="normal-vote-form" {% if vote_data.has_voted %}style="display:none"{% endif %}>
                                <input type="hidden" name="post_id" value="{{ post.post_id }}">
                                {% if vote_data.vote.vote_type == 2 %}
                                    <!-- 多选 -->
                                    {% for option in vote_data.options %}
                                        <div class="vote-option mb-2">
                                            <input type="checkbox" name="options[]" 
                                               id="option-{{ option.vote_option_id }}" 
                                               value="{{ option.vote_option_id }}">
                                            <label for="option-{{ option.vote_option_id }}">{{ option.title }}</label>
                                        </div>
                                    {% endfor %}
                                    <div class="vote-tip mb-2">
                                        <small class="text-muted"><i class="bi bi-info-circle"></i> Multiple choices</small>
                                    </div>
                                {% else %}
                                    <!-- 单选 -->
                                    {% for option in vote_data.options %}
                                        <div class="vote-option mb-2">
                                            <input type="radio" name="option" 
                                               id="option-{{ option.vote_option_id }}" 
                                               value="{{ option.vote_option_id }}">
                                            <label for="option-{{ option.vote_option_id }}">{{ option.title }}</label>
                                        </div>
                                    {% endfor %}
                                {% endif %}
                                <button type="button" class="btn vote-btn mt-2 submit-normal-vote-btn">Vote</button>
                            </form>
                            
                            {% if 'loggedin' not in session %}
                                <!-- 未登录提示 -->
                                <div class="login-to-vote text-center p-3">
                                    <p>Login to vote</p>
                                    <a href="{{ url_for('login') }}" class="btn login-btn">Login</a>
                                </div>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- 评论区 -->
    <div class="comments-section mt-4">
        <h5 class="section-title">Comments <span class="comments-count">{{ comments|length }}</span></h5>
        
        <!-- 添加评论表单 -->
        {% if 'loggedin' in session %}
            <div class="comment-form mb-4">
                <form id="commentForm">
                    <div class="d-flex">
                        <!-- 当前用户头像 -->
                        {% if current_user.profile_image %}
                            <img src="{{ url_for('get_profile_image', filename=current_user.profile_image) }}" class="comment-avatar" alt="{{ current_user.username }}">
                        {% else %}
                            <div class="comment-avatar-placeholder">
                                {{ current_user.username[0]|upper }}
                            </div>
                        {% endif %}
                        
                        <div class="comment-input-container">
                            <input type="text" name="content" class="form-control comment-input" placeholder="Write your comment..." required>
                            <input type="hidden" name="post_id" value="{{ post.post_id }}">
                            <button type="button" class="btn comment-submit-btn" id="submitComment">Send</button>
                        </div>
                    </div>
                </form>
                <div id="commentAlert" class="alert alert-dismissible fade mt-2" role="alert" style="display: none;">
                    <span id="comment-alert-message"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            </div>
        {% else %}
            <div class="login-to-comment mb-4">
                <a href="{{ url_for('login') }}">Login to comment</a>
            </div>
        {% endif %}
        
        <!-- 评论列表 -->
        <div class="comments-list" id="commentsContainer">
            {% if comments %}
                {% for comment in comments %}
                    <div class="comment-item" id="comment-{{ comment.comment_id }}">
                        <div class="d-flex">
                            <!-- 评论者头像 -->
                            {% if comment.profile_image %}
                                <img src="{{ url_for('get_profile_image', filename=comment.profile_image) }}" class="comment-avatar" alt="{{ comment.username }}">
                            {% else %}
                                <div class="comment-avatar-placeholder">
                                    {{ comment.username[0]|upper }}
                                </div>
                            {% endif %}
                            
                            <div class="comment-content">
                                <div class="comment-header">
                                    <span class="comment-username">{{ comment.username }}</span>
                                    <span class="comment-time">{{ comment.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                                </div>
                                <div class="comment-text whitespace-pre-wrap">{{ comment.content }}</div>
                                <div class="comment-actions">
                                    <!-- <button class="btn comment-like-btn like-comment-btn" style="opacity: 0.5; cursor: not-allowed;" data-comment-id="{{ comment.comment_id }}">
                                        <i class="bi bi-heart"></i> <span class="like-count">0</span>
                                    </button> -->
                                    
                                    {% if 'loggedin' in session and current_user.user_id == comment.user_id %}
                                    <button class="btn comment-delete-btn delete-comment-btn" style="opacity: 1; cursor: pointer;" data-comment-id="{{ comment.comment_id }}">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="no-comments" id="noCommentsMessage">
                    <div class="empty-icon">
                        <i class="bi bi-chat-dots"></i>
                    </div>
                    <p>No comments yet, be the first to comment!</p>
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- 图片查看模态框 -->
    <div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <img src="" class="img-fluid" id="modalImage">
                </div>
            </div>
        </div>
    </div>
    
    <!-- 视频播放器模态框 -->
    <div class="modal fade" id="videoModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <div class="ratio ratio-16x9">
                        <iframe id="videoFrame" src="" allowfullscreen></iframe>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* 小红书风格样式 */
    :root {
        --xhs-primary: #ff2442;
        --xhs-light: #fff6f7;
        --xhs-secondary: #ff8196;
        --xhs-dark: #333333;
        --xhs-gray: #999999;
        --xhs-light-gray: #f8f8f8;
        --xhs-border: #efefef;
    }
    
    .post-detail-container {
        max-width: 800px;
        padding-bottom: 50px;
    }
    
    .back-link {
        color: var(--xhs-dark);
        font-size: 15px;
    }
    
    .post-card {
        background-color: white;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
        padding: 20px;
        margin-bottom: 20px;
    }
    
    /* 用户信息样式 */
    .user-avatar, .user-avatar-placeholder {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
    }
    
    .user-avatar-placeholder {
        background-color: var(--xhs-light-gray);
        color: var(--xhs-gray);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
    }
    
    .username {
        font-weight: 600;
        font-size: 15px;
        color: var(--xhs-dark);
    }
    
    .post-time {
        font-size: 12px;
        color: var(--xhs-gray);
    }
    
    .follow-btn {
        background-color: var(--xhs-primary);
        color: white;
        border-radius: 20px;
        font-size: 13px;
        padding: 4px 16px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .follow-btn:hover {
        background-color: #e61e39;
        color: white;
    }
    
    .follow-btn.followed {
        background-color: #f5f5f5;
        color: #333;
    }
    
    .follow-btn.followed:hover {
        background-color: #e8e8e8;
        color: #333;
    }
    
    .share-btn {
        background-color: var(--xhs-light-gray);
        color: var(--xhs-dark);
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
    }
    
    .share-btn:hover {
        background-color: #e8e8e8;
    }
    
    /* 帖子内容样式 */
    .post-title {
        font-weight: 600;
        color: var(--xhs-dark);
        margin-top: 15px;
        /* 增强标题换行效果 */
        word-wrap: break-word;
        overflow-wrap: anywhere;
        word-break: break-word;
        hyphens: auto;
        max-width: 100%;
    }
    
    .post-text {
        font-size: 15px;
        line-height: 1.7;
        color: #505050;
        /* 增强内容换行效果 */
        word-wrap: break-word;
        overflow-wrap: anywhere;
        word-break: break-word;
        max-width: 100%;
    }
    
    .whitespace-pre-wrap {
        white-space: pre-wrap;
    }
    
    /* 图片样式 */
    .post-images-wrapper {
        width: 100%;
        position: relative;
        overflow: hidden;
        text-align: center;
        padding: 0;
        background-color: white;
    }
    
    .post-swiper {
        width: 100% !important;
        margin: 0;
        height: auto; 
        position: relative;
        z-index: 1;
    }
    
    .swiper-slide {
        width: 100% !important;
        height: auto;
        display: flex !important;
        align-items: center;
        justify-content: center;
        background-color: white;
        visibility: visible !important;
        opacity: 1 !important;
    }
    
    .swiper-slide img {
        width: 100%;
        height: auto;
        object-fit: cover;
        display: block;
        margin: 0;
    }
    
    .swiper-slide.portrait img {
        height: auto;
        width: 100%;
        max-width: 100%;
    }
    
    .swiper-slide.landscape img {
        width: 100%;
        height: auto;
        max-height: none;
    }
    
    /* 投票样式 */
    .vote-section {
        background-color: var(--xhs-light-gray);
        border-radius: 10px;
        padding: 20px;
    }
    
    .vote-title {
        font-weight: 600;
        font-size: 16px;
        margin-bottom: 15px;
    }
    
    /* PK投票样式 */
    .pk-options-row {
        display: flex;
        align-items: center;
        position: relative;
        height: 80px;
    }
    
    .pk-option {
        flex: 1;
        height: 100%;
        background-color: white;
        border-radius: 8px;
        position: relative;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .pk-option:hover {
        transform: translateY(-2px);
        box-shadow: 0 3px 10px rgba(0,0,0,0.08);
    }
    
    .pk-option.selected {
        background-color: rgba(255, 36, 66, 0.1);
    }
    
    .pk-option.selected-by-user {
        background-color: rgba(255, 36, 66, 0.2);
        border: 2px solid var(--xhs-primary);
    }
    
    .pk-option-content {
        padding: 10px;
        text-align: center;
        position: relative;
        z-index: 2;
    }
    
    .pk-option-title {
        font-weight: 500;
        font-size: 15px;
        margin-bottom: 5px;
    }
    
    .pk-option-percent {
        font-weight: 600;
        font-size: 18px;
        color: var(--xhs-primary);
    }
    
    .pk-vote-count {
        font-size: 12px;
        color: var(--xhs-gray);
    }
    
    .pk-option-bar {
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        background-color: rgba(255, 36, 66, 0.1);
        z-index: 1;
        transition: width 1s ease-out;
    }
    
    .pk-vs {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background-color: var(--xhs-primary);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        z-index: 3;
        margin: 0 -18px;
    }
    
    /* 常规投票样式 */
    .vote-option {
        background-color: white;
        border-radius: 8px;
        padding: 12px 15px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .vote-option:hover {
        background-color: #f5f5f5;
    }
    
    .vote-option input[type="radio"],
    .vote-option input[type="checkbox"] {
        margin-right: 10px;
    }
    
    .vote-option label {
        cursor: pointer;
        font-size: 15px;
        width: 100%;
    }
    
    .vote-result-item {
        margin-bottom: 15px;
    }
    
    .vote-result-item.selected .vote-option-title {
        font-weight: 600;
    }
    
    .vote-result-item.selected .progress-bar {
        background-color: var(--xhs-primary);
    }
    
    .vote-option-title {
        font-size: 14px;
    }
    
    .vote-percent {
        font-size: 14px;
        color: var(--xhs-primary);
        font-weight: 500;
    }
    
    .progress {
        height: 8px;
        border-radius: 4px;
        background-color: #e9e9e9;
    }
    
    .progress-bar {
        background-color: #aaaaaa;
        transition: width 1s ease-out;
    }
    
    .vote-btn {
        background-color: var(--xhs-primary);
        color: white;
        border: none;
        border-radius: 20px;
        padding: 6px 20px;
        font-size: 14px;
    }
    
    .vote-btn:hover {
        background-color: #e61e39;
        color: white;
    }
    
    .revote-btn {
        color: var(--xhs-primary);
        background-color: transparent;
        border: 1px solid var(--xhs-primary);
        border-radius: 15px;
        font-size: 12px;
        padding: 2px 10px;
    }
    
    .login-btn {
        background-color: var(--xhs-primary);
        color: white;
        border-radius: 20px;
        font-size: 14px;
        padding: 5px 20px;
    }
    
    /* 评论区样式 */
    .comments-section {
        background-color: white;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
        padding: 20px;
    }
    
    .section-title {
        font-weight: 600;
        font-size: 16px;
        margin-bottom: 20px;
        color: var(--xhs-dark);
    }
    
    .comments-count {
        color: var(--xhs-gray);
        font-weight: normal;
    }
    
    .comment-avatar, .comment-avatar-placeholder {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        object-fit: cover;
    }
    
    .comment-avatar-placeholder {
        background-color: var(--xhs-light-gray);
        color: var(--xhs-gray);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
    }
    
    .comment-input-container {
        flex: 1;
        margin-left: 10px;
        position: relative;
    }
    
    .comment-input {
        border-radius: 20px;
        padding-right: 60px;
        border: 1px solid #e0e0e0;
    }
    
    .comment-input:focus {
        box-shadow: none;
        border-color: var(--xhs-primary);
    }
    
    .comment-submit-btn {
        position: absolute;
        right: 5px;
        top: 50%;
        transform: translateY(-50%);
        background-color: var(--xhs-primary);
        color: white;
        border-radius: 20px;
        padding: 3px 12px;
        font-size: 13px;
    }
    
    .login-to-comment {
        text-align: center;
        padding: 15px;
        background-color: var(--xhs-light-gray);
        border-radius: 8px;
    }
    
    .login-to-comment a {
        color: var(--xhs-primary);
        text-decoration: none;
    }
    
    .comment-item {
        padding: 15px 0;
        border-bottom: 1px solid var(--xhs-border);
    }
    
    .comment-item:last-child {
        border-bottom: none;
    }
    
    .comment-content {
        flex: 1;
        margin-left: 10px;
    }
    
    .comment-header {
        margin-bottom: 5px;
    }
    
    .comment-username {
        font-weight: 500;
        font-size: 14px;
        color: var(--xhs-dark);
    }
    
    .comment-time {
        font-size: 12px;
        color: var(--xhs-gray);
        margin-left: 8px;
    }
    
    .comment-text {
        font-size: 14px;
        line-height: 1.5;
        margin-bottom: 8px;
    }
    
    .comment-actions {
        display: flex;
        align-items: center;
    }
    
    .comment-like-btn, .comment-delete-btn {
        background: none;
        border: none;
        color: var(--xhs-gray);
        font-size: 12px;
        padding: 0;
        margin-right: 15px;
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .comment-like-btn:hover {
        color: var(--xhs-primary);
    }
    
    .comment-delete-btn {
        opacity: 1;
        cursor: pointer;
    }
    
    .comment-delete-btn:hover {
        color: #dc3545;
    }
    
    .no-comments {
        text-align: center;
        padding: 40px 0;
        color: var(--xhs-gray);
    }
    
    .empty-icon {
        font-size: 40px;
        margin-bottom: 10px;
        opacity: 0.3;
    }
    .back-link a {
        color: #E60012;
    }

    .back-link a i {
        color: #E60012;
    }

    /* 轮播图样式优化 */
    .post-images-wrapper {
        width: 100%;
        position: relative;
        overflow: hidden;
        text-align: center;
        padding: 0;
        background-color: white;
    }
    
    .post-swiper {
        width: 100% !important;
        margin: 0;
        height: auto; 
        position: relative;
        z-index: 1;
    }
    
    .swiper-slide {
        width: 100% !important;
        height: auto;
        display: flex !important;
        align-items: center;
        justify-content: center;
        background-color: white;
        visibility: visible !important;
        opacity: 1 !important;
    }
    
    .swiper-slide img {
        width: 100%;
        height: auto;
        object-fit: cover;
        display: block;
        margin: 0;
    }
    
    /* 确保内容正确显示，不会重叠 */
    .post-title, .post-text, .vote-section, .comments-section {
        position: relative;
        z-index: 2;
        clear: both;
    }
    
    /* 导航按钮样式 */
    .swiper-button-next,
    .swiper-button-prev {
        color: white;
        background: rgba(0, 0, 0, 0.3);
        width: 32px;
        height: 32px;
        border-radius: 50%;
        --swiper-navigation-size: 18px;
    }
    
    .swiper-button-next:after,
    .swiper-button-prev:after {
        font-size: 16px;
        font-weight: bold;
    }
    
    /* 分页器样式 */
    .swiper-pagination {
        position: absolute;
        bottom: 10px;
    }
    
    .swiper-pagination-bullet {
        width: 8px;
        height: 8px;
        background: #a4a2a2;
        opacity: 0.6;
    }
    
    .swiper-pagination-bullet-active {
        background: #ff2442;
        opacity: 1;
    }
    
    /* 评论区样式优化 */
    .comments-section {
        margin-top: 30px;
        clear: both;
    }
    
    /* 图片计数器样式 */
    .image-counter {
        position: absolute;
        bottom: 10px;
        right: 10px;
        background: rgba(0, 0, 0, 0.5);
        color: white;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        z-index: 10;
    }
    
    /* 确保所有幻灯片都可见 */
    .swiper-wrapper {
        align-items: stretch;
    }
    
    .swiper-slide {
        opacity: 1 !important;
        visibility: visible !important;
        transition: transform 0.3s ease;
        height: auto;
    }
    
    /* 加载指示器样式 */
    .swiper-lazy-preloader {
        border-color: #ff2442;
    }

    /* 移除post-card中所有可能的内边距 */
    .post-card {
        padding: 0 !important;
    }

    /* 修复post-card和post-content之间的宽度差异 */
    @media (min-width: 768px) {
        .post-images-wrapper, .post-content, .post-card, .post-user-info {
            max-width: 100% !important;
            width: 100% !important;
        }
    }

    /* 确保用户信息区域也没有外边距 */
    .post-user-info {
        margin: 0;
        padding: 15px 20px;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 图片模态框功能
        const imageModal = document.getElementById('imageModal');
        if (imageModal) {
            imageModal.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;
                const imgSrc = button.getAttribute('data-bs-img');
                document.getElementById('modalImage').src = imgSrc;
            });
        }
        
        // 处理帖子内容中的链接，使其可点击并弹出视频模态框
        const postContent = document.getElementById('post-content');
        if (postContent) {
            // 一般URL链接的正则表达式
            const urlRegex = /(https?:\/\/(?:www\.)?[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b(?:[-a-zA-Z0-9()@:%_\+.~#?&\/=]*))/g;
            
            // 将纯文本内容中的URL转换为可点击的链接
            let contentHtml = postContent.textContent;
            contentHtml = contentHtml.replace(urlRegex, (match) => {
                // 检查是否是视频链接
                if (isVideoUrl(match)) {
                    return `<a href="${match}" class="video-link" data-video-url="${match}">${match}</a>`;
                } else {
                    // 普通链接，在新窗口打开
                    return `<a href="${match}" target="_blank">${match}</a>`;
                }
            });
            postContent.innerHTML = contentHtml;
            
            // 判断URL是否是视频链接
            function isVideoUrl(url) {
                const videoPatterns = [
                    'youtube.com/watch', 'youtu.be/', 'youtube.com/shorts/',
                    'vimeo.com/', 
                    'bilibili.com/video/', 
                    'v.qq.com/', 
                    'dailymotion.com/video/',
                    'facebook.com/watch',
                    'twitch.tv/',
                    'tiktok.com/',
                    'instagram.com/reel/',
                    'instagram.com/p/',
                    'xigua.com/'
                ];
                
                return videoPatterns.some(pattern => url.includes(pattern));
            }
            
            // 添加视频链接的点击事件
            document.querySelectorAll('.video-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    const videoUrl = this.getAttribute('data-video-url');
                    console.log('Opening video:', videoUrl);
                    
                    // 根据URL类型设置不同的嵌入链接
                    let embedUrl = getEmbedUrl(videoUrl);
                    
                    // 设置iframe的src并打开模态框
                    document.getElementById('videoFrame').src = embedUrl;
                    const videoModal = new bootstrap.Modal(document.getElementById('videoModal'));
                    videoModal.show();
                });
            });
            
            // 根据不同的视频网站生成嵌入链接
            function getEmbedUrl(videoUrl) {
                // YouTube - 支持普通视频和shorts
                if (videoUrl.includes('youtube.com/watch?v=') || videoUrl.includes('youtu.be/')) {
                    const videoId = videoUrl.includes('youtube.com/watch?v=') 
                        ? videoUrl.split('v=')[1].split('&')[0]
                        : videoUrl.split('youtu.be/')[1].split('?')[0];
                    return `https://www.youtube.com/embed/${videoId}?autoplay=1`;
                }
                // YouTube Shorts
                else if (videoUrl.includes('youtube.com/shorts/')) {
                    const videoId = videoUrl.split('shorts/')[1].split('?')[0];
                    return `https://www.youtube.com/embed/${videoId}?autoplay=1`;
                }
                // Vimeo
                else if (videoUrl.includes('vimeo.com/')) {
                    const videoId = videoUrl.split('vimeo.com/')[1].split('?')[0];
                    return `https://player.vimeo.com/video/${videoId}?autoplay=1`;
                }
                // 哔哩哔哩
                else if (videoUrl.includes('bilibili.com/video/')) {
                    let videoId = videoUrl.match(/bilibili\.com\/video\/([^\/\?\s]+)/);
                    videoId = videoId ? videoId[1] : '';
                    return `https://player.bilibili.com/player.html?bvid=${videoId}&autoplay=1`;
                }
                // 腾讯视频
                else if (videoUrl.includes('v.qq.com/')) {
                    let videoId = '';
                    const matchVid = videoUrl.match(/\/([a-zA-Z0-9]+)\.html/);
                    if (matchVid) videoId = matchVid[1];
                    return `https://v.qq.com/txp/iframe/player.html?vid=${videoId}&auto=1`;
                }
                // Facebook
                else if (videoUrl.includes('facebook.com/watch')) {
                    return `https://www.facebook.com/plugins/video.php?href=${encodeURIComponent(videoUrl)}&show_text=0&autoplay=true`;
                }
                // Instagram
                else if (videoUrl.includes('instagram.com/')) {
                    return `https://www.instagram.com/p/${videoUrl.split('/p/')[1].split('/')[0]}/embed/`;
                }
                // TikTok
                else if (videoUrl.includes('tiktok.com/')) {
                    return `https://www.tiktok.com/embed/${videoUrl.split('/video/')[1].split('?')[0]}`;
                }
                // 西瓜视频
                else if (videoUrl.includes('xigua.com/')) {
                    let videoId = '';
                    const matchVid = videoUrl.match(/\/([a-zA-Z0-9]+)/);
                    if (matchVid) videoId = matchVid[1];
                    return `https://www.ixigua.com/iframe/${videoId}`;
                }
                // 其他视频网站
                else {
                    // 默认尝试直接在iframe中加载
                    return videoUrl;
                }
            }
        }
        
        // 视频模态框关闭时，停止视频播放
        const videoModal = document.getElementById('videoModal');
        if (videoModal) {
            videoModal.addEventListener('hidden.bs.modal', function () {
                document.getElementById('videoFrame').src = '';
            });
        }
        
        // 图片方向检测和处理
        const swiperSlides = document.querySelectorAll('.swiper-slide');
        
        swiperSlides.forEach(slide => {
            const img = slide.querySelector('img');
            if (img) {
                img.onload = function() {
                    if (this.naturalWidth > this.naturalHeight) {
                        // 横向图片
                        slide.classList.add('landscape');
                    } else {
                        // 纵向图片
                        slide.classList.add('portrait');
                    }
                };
                
                // 如果图片已经加载完成，立即检查方向
                if (img.complete) {
                    if (img.naturalWidth > img.naturalHeight) {
                        slide.classList.add('landscape');
                    } else {
                        slide.classList.add('portrait');
                    }
                }
            }
        });

        // 初始化轮播图 (如果有Swiper库)
        if (typeof Swiper !== 'undefined') {
            setTimeout(() => {
                try {
                    console.log("初始化轮播图...");
                    const swiperElement = document.querySelector('.post-swiper');
                    const currentIndexEl = document.querySelector('.current-index');
                    const totalImagesEl = document.querySelector('.total-images');
                    
                    if (swiperElement) {
                        const swiper = new Swiper('.post-swiper', {
                            // 基本配置
                            slidesPerView: 1,
                            spaceBetween: 0,
                            speed: 300,
                            centeredSlides: true, // 确保幻灯片居中
                            
                            // 循环和自动高度
                            loop: false,
                            
                            // 延迟加载
                            lazy: {
                                loadPrevNext: true,
                                loadPrevNextAmount: 2,
                            },
                            
                            // 触摸配置
                            grabCursor: true,
                            touchRatio: 1,
                            simulateTouch: true,
                            
                            // 分页器
                            pagination: {
                                el: '.swiper-pagination',
                                clickable: true,
                                dynamicBullets: true
                            },
                            
                            // 导航按钮
                            navigation: {
                                nextEl: '.swiper-button-next',
                                prevEl: '.swiper-button-prev'
                            },
                            
                            // 回调函数
                            on: {
                                init: function() {
                                    console.log('轮播图初始化成功!');
                                    console.log('总共图片数量:', this.slides.length);
                                    
                                    // 更新总图片数量
                                    if (totalImagesEl) {
                                        totalImagesEl.textContent = this.slides.length;
                                    }
                                },
                                slideChange: function() {
                                    console.log('当前索引:', this.activeIndex + 1);
                                    
                                    // 更新当前图片索引
                                    if (currentIndexEl) {
                                        currentIndexEl.textContent = this.activeIndex + 1;
                                    }
                                }
                            }
                        });
                        
                        // 记录初始化的Swiper
                        window.postSwiper = swiper;
                        console.log("轮播图实例已创建");
                    } else {
                        console.warn('找不到.post-swiper元素');
                    }
                } catch (e) {
                    console.error("Swiper初始化错误:", e);
                }
            }, 600); // 延迟时间增加
        } else {
            console.warn('Swiper库未加载，请检查网络连接');
        }
        
        // 显示提示信息
        function showAlert(elementId, message, type = 'success') {
            const alertEl = document.getElementById(elementId);
            const messageEl = alertEl.querySelector('span');
            
            alertEl.classList.remove('alert-success', 'alert-danger', 'alert-warning');
            alertEl.classList.add(`alert-${type}`);
            alertEl.classList.add('show');
            messageEl.textContent = message;
            alertEl.style.display = 'block';
            
            // 3秒后自动隐藏
            setTimeout(() => {
                alertEl.classList.remove('show');
                setTimeout(() => {
                    alertEl.style.display = 'none';
                }, 300);
            }, 3000);
        }
        
        // 更新投票结果UI函数
        function updateVoteResults(data) {
            // 获取总投票数
            const totalVotes = data.total_votes;
            
            // 根据投票类型更新UI
            const isPkVote = document.querySelector('.pk-vote-container') !== null;
            
            if (isPkVote) {
                // PK投票样式更新
                const pkOptions = document.querySelectorAll('.pk-option');
                
                pkOptions.forEach(option => {
                    const optionId = parseInt(option.getAttribute('data-option-id'));
                    
                    // 在选项数据中找到匹配的选项
                    const optionData = data.options.find(opt => opt.vote_option_id === optionId);
                    if (optionData) {
                        // 计算百分比
                        const percent = totalVotes > 0 ? Math.round((optionData.vote_count / totalVotes) * 100) : 0;
                        
                        // 更新百分比显示
                        const percentEl = option.querySelector('.pk-option-percent');
                        if (percentEl) {
                            percentEl.textContent = `${percent}%`;
                            percentEl.style.display = 'block';
                        }
                        
                        // 更新票数显示
                        const voteCountEl = option.querySelector('.pk-vote-count');
                        if (voteCountEl) {
                            voteCountEl.textContent = `(${optionData.vote_count} votes)`;
                            voteCountEl.style.display = 'block';
                        }
                        
                        // 更新进度条
                        const barEl = option.querySelector('.pk-option-bar');
                        if (barEl) {
                            barEl.style.width = `${percent}%`;
                        }
                        
                        // 更新选中状态
                        if (data.user_voted_options.includes(optionId)) {
                            option.classList.add('selected');
                        } else {
                            option.classList.remove('selected');
                        }
                    }
                });
            } else {
                // 常规投票结果更新（原有逻辑）
                // 获取投票结果容器
                const voteResults = document.getElementById('vote-results');
                if (!voteResults) return;
                
                // 更新总投票人数
                const totalVoteCount = document.getElementById('total-vote-count');
                if (totalVoteCount) {
                    totalVoteCount.textContent = data.total_votes;
                }
                
                // 更新每个选项的结果
                const options = data.options;
                const userVotedOptions = data.user_voted_options;
                
                // 查找所有结果项
                const resultItems = voteResults.querySelectorAll('.vote-result-item');
                resultItems.forEach((item, index) => {
                    if (index < options.length) {
                        const option = options[index];
                        
                        // 更新百分比和票数
                        const percentEl = item.querySelector('.vote-percent');
                        if (percentEl) {
                            percentEl.textContent = `${option.percent}% (${option.vote_count} votes)`;
                        }
                        
                        // 更新进度条
                        const progressBar = item.querySelector('.progress-bar');
                        if (progressBar) {
                            progressBar.style.width = `${option.percent}%`;
                        }
                        
                        // 更新选中状态
                        const optionId = parseInt(item.getAttribute('data-option-id') || 0);
                        if (userVotedOptions.includes(optionId)) {
                            item.classList.add('selected');
                        } else {
                            item.classList.remove('selected');
                        }
                    }
                });
            }
        }
        
        // ============ PK投票功能 ============
        // 查找PK选项元素
        const pkOptions = document.querySelectorAll('.pk-option');
        const pkVoteBtn = document.getElementById('pk-vote-btn');
        let selectedPkOption = null;
        
        // 为PK选项添加点击事件
        if (pkOptions.length > 0 && pkVoteBtn) {
            pkOptions.forEach(option => {
                option.addEventListener('click', function() {
                    // 取消所有选中状态
                    pkOptions.forEach(opt => opt.classList.remove('selected-by-user'));
                    
                    // 添加选中状态给当前选项
                    this.classList.add('selected-by-user');
                    
                    // 获取选项ID并存储
                    selectedPkOption = this.getAttribute('data-option-id');
                    
                    // 更新隐藏输入字段
                    const hiddenInput = document.getElementById('pk-selected-option');
                    if (hiddenInput) {
                        hiddenInput.value = selectedPkOption;
                    }
                    
                    // 启用投票按钮
                    pkVoteBtn.disabled = false;
                });
            });
            
            // 处理PK投票按钮点击
            pkVoteBtn.addEventListener('click', function() {
                if (!selectedPkOption) {
                    showAlert('vote-alert', 'Please select an option', 'warning');
                    return;
                }
                
                // 禁用按钮，防止重复提交
                this.disabled = true;
                this.textContent = 'Submitting...';
                
                // 获取表单并构建表单数据
                const form = document.getElementById('pkVoteForm');
                const formData = new FormData(form);
                
                // 发送投票请求
                fetch('/api/vote', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAlert('vote-alert', data.message, 'success');
                        
                        // 更新UI显示选中状态和百分比
                        updateVoteResults(data.data);
                        
                        // 隐藏投票按钮
                        this.style.display = 'none';
                    } else {
                        showAlert('vote-alert', data.message, 'danger');
                        this.disabled = false;
                        this.textContent = 'Vote';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('vote-alert', 'Vote submission failed, please try again later', 'danger');
                    this.disabled = false;
                    this.textContent = 'Vote';
                });
            });
        }
        
        // ============ 常规投票功能 ============
        const submitNormalVoteBtn = document.querySelector('.submit-normal-vote-btn');
        
        // 常规投票提交
        if (submitNormalVoteBtn) {
            submitNormalVoteBtn.addEventListener('click', function() {
                const form = document.getElementById('normalVoteForm');
                const formData = new FormData(form);
                
                // 检查是否选择了选项
                const isMultiSelect = form.querySelector('input[type="checkbox"][name="options[]"]') !== null;
                
                if (isMultiSelect) {
                    // 多选：检查是否至少选择了一个选项
                    const checkboxes = form.querySelectorAll('input[type="checkbox"][name="options[]"]:checked');
                    if (checkboxes.length === 0) {
                        showAlert('vote-alert', 'Please select at least one option', 'warning');
                        return;
                    }
                    
                    // 处理多选数据
                    formData.delete('options[]');
                    checkboxes.forEach(checkbox => {
                        formData.append('options', checkbox.value);
                    });
                    
                    console.log('Submitted multi-select vote data:', Array.from(formData.entries()));
                } else {
                    // 单选：检查是否选择了选项
                    const selectedOption = form.querySelector('input[type="radio"][name="option"]:checked');
                    if (!selectedOption) {
                        showAlert('vote-alert', 'Please select an option', 'warning');
                        return;
                    }
                    
                    console.log('Submitted single-select vote data:', Array.from(formData.entries()));
                }
                
                // 禁用按钮，防止重复提交
                this.disabled = true;
                this.textContent = 'Submitting...';
                
                fetch('/api/vote', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAlert('vote-alert', data.message, 'success');
                        
                        // 更新投票结果UI
                        updateVoteResults(data.data);
                        
                        // 显示结果，隐藏表单
                        document.getElementById('normalVoteForm').style.display = 'none';
                        document.getElementById('vote-results').style.display = 'block';
                    } else {
                        showAlert('vote-alert', data.message, 'danger');
                        this.disabled = false;
                        this.textContent = 'Vote';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('vote-alert', 'Vote submission failed, please try again later', 'danger');
                    this.disabled = false;
                    this.textContent = 'Vote';
                });
            });
        }
        
        // 关注/取消关注功能
        const followBtn = document.querySelector('.follow-btn');
        
        if (followBtn) {
            followBtn.addEventListener('click', function() {
                const userId = this.getAttribute('data-user-id');
                const formData = new FormData();
                formData.append('user_id', userId);
                
                // 禁用按钮，防止重复点击
                this.disabled = true;
                
                fetch('/api/follow', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 更新按钮文本和样式
                        if (data.data.is_following) {
                            this.innerHTML = '<i class="bi bi-check"></i> Following';
                            this.classList.add('followed');
                        } else {
                            this.innerHTML = '<i class="bi bi-plus"></i> Follow';
                            this.classList.remove('followed');
                        }
                        
                        // 显示成功消息
                        showAlert('vote-alert', data.message, 'success');
                    } else {
                        showAlert('vote-alert', data.message, 'danger');
                    }
                    this.disabled = false;
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('vote-alert', '操作失败，请稍后重试', 'danger');
                    this.disabled = false;
                });
            });
        }
        
        // ============ 评论功能 ============
        const submitCommentBtn = document.getElementById('submitComment');
        const commentForm = document.getElementById('commentForm');
        const commentsContainer = document.getElementById('commentsContainer');
        const noCommentsMessage = document.getElementById('noCommentsMessage');
        
        if (submitCommentBtn && commentForm) {
            submitCommentBtn.addEventListener('click', function() {
                // 获取评论内容
                const commentInput = commentForm.querySelector('input[name="content"]');
                const content = commentInput.value.trim();
                
                if (!content) {
                    showAlert('commentAlert', 'Please enter a comment', 'warning');
                    return;
                }
                
                // 禁用按钮，防止重复提交
                this.disabled = true;
                this.textContent = 'Sending...';
                
                // 创建FormData对象
                const formData = new FormData(commentForm);
                
                // 发送评论请求
                fetch('/api/comments', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 显示成功消息
                        showAlert('commentAlert', data.message, 'success');
                        
                        // 清空评论输入框
                        commentInput.value = '';
                        
                        // 更新评论计数
                        const commentsCountEl = document.querySelector('.comments-count');
                        const currentCount = parseInt(commentsCountEl.textContent || '0');
                        commentsCountEl.textContent = currentCount + 1;
                        
                        // 添加新评论到评论列表
                        const comment = data.data;
                        
                        // 如果没有评论，移除"没有评论"的提示
                        if (noCommentsMessage) {
                            noCommentsMessage.style.display = 'none';
                        }
                        
                        // 创建评论HTML
                        const commentHtml = `
                            <div class="comment-item" id="comment-${comment.comment_id}">
                                <div class="d-flex">
                                    ${comment.profile_image 
                                        ? `<img src="/profile/image/${comment.profile_image}" class="comment-avatar" alt="${comment.username}">`
                                        : `<div class="comment-avatar-placeholder">${comment.username[0].toUpperCase()}</div>`
                                    }
                                    
                                    <div class="comment-content">
                                        <div class="comment-header">
                                            <span class="comment-username">${comment.username}</span>
                                            <span class="comment-time">${comment.created_at_formatted}</span>
                                        </div>
                                        <div class="comment-text whitespace-pre-wrap">${comment.content}</div>
                                        <div class="comment-actions">
                                            <button class="btn comment-delete-btn delete-comment-btn" style="opacity: 1; cursor: pointer;" data-comment-id="${comment.comment_id}">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        // 将新评论添加到评论列表开头
                        commentsContainer.insertAdjacentHTML('afterbegin', commentHtml);
                        
                        // 为新评论添加事件监听器
                        const newComment = document.getElementById(`comment-${comment.comment_id}`);
                        if (newComment) {
                            const likeBtn = newComment.querySelector('.like-comment-btn');
                            const deleteBtn = newComment.querySelector('.delete-comment-btn');
                            
                            // 如果有点赞按钮事件处理程序，在这里添加
                            // if (likeBtn && typeof addLikeEventListener === 'function') {
                            //     addLikeEventListener(likeBtn);
                            // }
                            
                            // 添加删除按钮事件处理程序
                            if (deleteBtn) {
                                addDeleteEventListener(deleteBtn);
                            }
                        }
                    } else {
                        showAlert('commentAlert', data.message, 'danger');
                    }
                    
                    // 重新启用按钮
                    this.disabled = false;
                    this.textContent = 'Send';
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('commentAlert', '评论失败，请稍后重试', 'danger');
                    this.disabled = false;
                    this.textContent = 'Send';
                });
            });
            
            // 添加按Enter键发送评论的功能
            const commentInput = commentForm.querySelector('input[name="content"]');
            if (commentInput) {
                commentInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !submitCommentBtn.disabled) {
                        e.preventDefault();
                        submitCommentBtn.click();
                    }
                });
            }
        }
        
        // 评论删除功能
        function addDeleteEventListener(deleteBtn) {
            deleteBtn.addEventListener('click', function() {
                if (!confirm('Are you sure you want to delete this comment?')) {
                    return;
                }
                
                const commentId = this.getAttribute('data-comment-id');
                const commentItem = document.getElementById(`comment-${commentId}`);
                
                // 禁用按钮，防止重复点击
                this.disabled = true;
                
                // 创建FormData对象
                const formData = new FormData();
                formData.append('comment_id', commentId);
                
                // 发送删除请求
                fetch('/api/comments/delete', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 显示成功消息
                        showAlert('commentAlert', data.message || 'Comment deleted', 'success');
                        
                        // 从DOM中移除该评论
                        if (commentItem) {
                            commentItem.remove();
                            
                            // 更新评论计数
                            const commentsCountEl = document.querySelector('.comments-count');
                            const currentCount = parseInt(commentsCountEl.textContent || '0');
                            commentsCountEl.textContent = Math.max(0, currentCount - 1);
                            
                            // 如果没有评论了，显示"没有评论"的提示
                            if (currentCount - 1 === 0 && noCommentsMessage) {
                                noCommentsMessage.style.display = 'block';
                            }
                        }
                    } else {
                        showAlert('commentAlert', data.message, 'danger');
                        this.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('commentAlert', 'Delete failed, please try again later', 'danger');
                    this.disabled = false;
                });
            });
        }
        
        // 为所有现有的删除按钮添加事件监听器
        document.querySelectorAll('.delete-comment-btn').forEach(deleteBtn => {
            addDeleteEventListener(deleteBtn);
        });
        
        // 为评论点赞按钮添加提示功能
        document.querySelectorAll('.like-comment-btn').forEach(likeBtn => {
            likeBtn.addEventListener('click', function(event) {
                event.preventDefault();
                showAlert('commentAlert', 'Comment like feature not implemented yet', 'info');
            });
        });
    });
</script>
{% endblock %}