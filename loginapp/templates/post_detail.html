{% extends "userbase.html" %}
{% set active_page = 'home' %}
{% block title %}{{ post.title }}{% endblock %}

{% block content %}
<div class="container post-detail-container">
    <!-- 返回按钮 -->
    <div class="back-link mb-3 mt-3">
        <a href="{{ url_for('visitor_home') }}" class="text-decoration-none">
            <i class="bi bi-arrow-left"></i> 返回
        </a>
    </div>
    
    <!-- 帖子内容卡片 -->
    <div class="post-card">
        <!-- 用户信息区域 -->
        <div class="post-user-info d-flex justify-content-between align-items-center mb-3">
            <div class="d-flex align-items-center">
                <!-- 用户头像 -->
                {% if post.profile_image %}
                    <img src="{{ url_for('get_profile_image', filename=post.profile_image) }}" class="user-avatar" alt="{{ post.username }}">
                {% else %}
                    <div class="user-avatar-placeholder">
                        {{ post.username[0]|upper }}
                    </div>
                {% endif %}
                
                <!-- 用户名 -->
                <div class="ms-2">
                    <div class="username">{{ post.username }}</div>
                    <div class="post-time">{{ post.created_at.strftime('%Y-%m-%d %H:%M') }}</div>
                </div>
            </div>
            
            <!-- 关注按钮和分享图标 -->
            <div>
                {% if not is_author and 'loggedin' in session %}
                    <button class="btn follow-btn {% if is_following %}followed{% endif %}" data-user-id="{{ post.author_id }}">
                        {% if is_following %}
                            <i class="bi bi-check"></i> 已关注
                        {% else %}
                            <i class="bi bi-plus"></i> 关注
                        {% endif %}
                    </button>
                {% endif %}
                <button class="btn share-btn ms-2">
                    <i class="bi bi-share"></i>
                </button>
            </div>
        </div>
        
        <!-- 帖子内容区域 -->
        <div class="post-content">
            <!-- 图片区域 (如果有图片) -->
            {% if images %}
                <div class="post-images mb-4">
                    {% if images|length == 1 %}
                        <!-- 单张图片 -->
                        <div class="single-image">
                            <img src="{{ url_for('get_post_image', filename=images[0].image_path) }}" 
                                 class="img-fluid" 
                                 data-bs-toggle="modal"
                                 data-bs-target="#imageModal"
                                 data-bs-img="{{ url_for('get_post_image', filename=images[0].image_path) }}">
                        </div>
                    {% else %}
                        <!-- 多张图片 -->
                        <div class="images-grid">
                            <div class="swiper post-swiper">
                                <div class="swiper-wrapper">
                                    {% for image in images %}
                                        <div class="swiper-slide">
                                            <img src="{{ url_for('get_post_image', filename=image.image_path) }}" 
                                                 class="img-fluid" 
                                                 data-bs-toggle="modal"
                                                 data-bs-target="#imageModal"
                                                 data-bs-img="{{ url_for('get_post_image', filename=image.image_path) }}">
                                        </div>
                                    {% endfor %}
                                </div>
                                <div class="swiper-pagination"></div>
                            </div>
                        </div>
                    {% endif %}
                </div>
            {% endif %}
            
            <!-- 标题和内容 -->
            <h4 class="post-title mb-3">{{ post.title }}</h4>
            <div class="post-text whitespace-pre-wrap mb-4">{{ post.content }}</div>
            
            <!-- 投票区域 (如果有投票) -->
            {% if vote_data %}
                <div class="vote-section mt-4 mb-4">
                    <h5 class="vote-title mb-3">{{ vote_data.vote.vote_title }}</h5>
                    <div id="vote-alert" class="alert alert-dismissible fade" role="alert" style="display: none;">
                        <span id="vote-alert-message"></span>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                    
                    {% if vote_data.options|length == 2 %}
                        <!-- PK样式投票 (两个选项) -->
                        <div class="pk-vote-container">
                            <div class="pk-options-row">
                                {% for option in vote_data.options %}
                                    {% set percent = ((option.vote_count / vote_data.total_votes) * 100)|int if vote_data.total_votes > 0 else 50 %}
                                    <div class="pk-option {% if vote_data.has_voted and option.vote_option_id in vote_data.user_voted_options %}selected{% endif %}"
                                         data-option-id="{{ option.vote_option_id }}">
                                        <div class="pk-option-content">
                                            <div class="pk-option-title">{{ option.title }}</div>
                                            <div class="pk-option-percent" {% if not vote_data.has_voted %}style="display:none"{% endif %}>
                                                {{ percent }}%
                                            </div>
                                            <div class="pk-vote-count" {% if not vote_data.has_voted %}style="display:none"{% endif %}>
                                                ({{ option.vote_count }}票)
                                            </div>
                                        </div>
                                        <div class="pk-option-bar" style="width: {{ percent if vote_data.has_voted else 0 }}%"></div>
                                    </div>
                                    
                                    {% if loop.first %}
                                        <div class="pk-vs">VS</div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            
                            {% if 'loggedin' in session and not vote_data.has_voted %}
                                <form id="pkVoteForm" class="text-center mt-3">
                                    <input type="hidden" name="option" id="pk-selected-option">
                                    <input type="hidden" name="post_id" value="{{ post.post_id }}">
                                    <button type="button" class="btn vote-btn" id="pk-vote-btn" disabled>投票</button>
                                </form>
                            {% endif %}
                        </div>
                    {% else %}
                        <!-- 常规样式投票 (三个或更多选项) -->
                        <div class="normal-vote-container">
                            <div id="vote-results" class="vote-results" {% if not vote_data.has_voted %}style="display:none"{% endif %}>
                                {% for option in vote_data.options %}
                                    {% set percent = ((option.vote_count / vote_data.total_votes) * 100)|int if vote_data.total_votes > 0 else 0 %}
                                    <div class="vote-result-item {% if option.vote_option_id in vote_data.user_voted_options %}selected{% endif %}">
                                        <div class="d-flex justify-content-between mb-1">
                                            <div class="vote-option-title">{{ option.title }}</div>
                                            <div class="vote-percent">{{ percent }}% ({{ option.vote_count }}票)</div>
                                        </div>
                                        <div class="progress">
                                            <div class="progress-bar" role="progressbar" style="width: {{ percent }}%"></div>
                                        </div>
                                    </div>
                                {% endfor %}
                                <div class="vote-total text-center mt-3">
                                    <small>共 <span id="total-vote-count">{{ vote_data.total_votes }}</span> 人参与投票</small>
                                    {% if 'loggedin' in session %}
                                        <button class="btn btn-sm revote-btn ms-3" type="button" data-bs-toggle="collapse" data-bs-target="#revoteForm">
                                            重新投票
                                        </button>
                                        
                                        <div class="collapse mt-3" id="revoteForm">
                                            <form id="revoteForm" class="revote-form">
                                                <input type="hidden" name="post_id" value="{{ post.post_id }}">
                                                {% if vote_data.vote.vote_type == 2 %}
                                                    <!-- 多选 -->
                                                    {% for option in vote_data.options %}
                                                        <div class="vote-option mb-2">
                                                            <input type="checkbox" name="options[]" 
                                                                id="revote-option-{{ option.vote_option_id }}" 
                                                                value="{{ option.vote_option_id }}"
                                                                {% if option.vote_option_id in vote_data.user_voted_options %}checked{% endif %}>
                                                            <label for="revote-option-{{ option.vote_option_id }}">{{ option.title }}</label>
                                                        </div>
                                                    {% endfor %}
                                                {% else %}
                                                    <!-- 单选 -->
                                                    {% for option in vote_data.options %}
                                                        <div class="vote-option mb-2">
                                                            <input type="radio" name="option" 
                                                                id="revote-option-{{ option.vote_option_id }}" 
                                                                value="{{ option.vote_option_id }}"
                                                                {% if option.vote_option_id in vote_data.user_voted_options %}checked{% endif %}>
                                                            <label for="revote-option-{{ option.vote_option_id }}">{{ option.title }}</label>
                                                        </div>
                                                    {% endfor %}
                                                {% endif %}
                                                <button type="button" class="btn vote-btn mt-2 submit-revote-btn">提交</button>
                                            </form>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <form id="normalVoteForm" class="normal-vote-form" {% if vote_data.has_voted %}style="display:none"{% endif %}>
                                <input type="hidden" name="post_id" value="{{ post.post_id }}">
                                {% if vote_data.vote.vote_type == 2 %}
                                    <!-- 多选 -->
                                    {% for option in vote_data.options %}
                                        <div class="vote-option mb-2">
                                            <input type="checkbox" name="options[]" 
                                               id="option-{{ option.vote_option_id }}" 
                                               value="{{ option.vote_option_id }}">
                                            <label for="option-{{ option.vote_option_id }}">{{ option.title }}</label>
                                        </div>
                                    {% endfor %}
                                    <div class="vote-tip mb-2">
                                        <small class="text-muted"><i class="bi bi-info-circle"></i> 可多选</small>
                                    </div>
                                {% else %}
                                    <!-- 单选 -->
                                    {% for option in vote_data.options %}
                                        <div class="vote-option mb-2">
                                            <input type="radio" name="option" 
                                               id="option-{{ option.vote_option_id }}" 
                                               value="{{ option.vote_option_id }}">
                                            <label for="option-{{ option.vote_option_id }}">{{ option.title }}</label>
                                        </div>
                                    {% endfor %}
                                {% endif %}
                                <button type="button" class="btn vote-btn mt-2 submit-normal-vote-btn">投票</button>
                            </form>
                            
                            {% if 'loggedin' not in session %}
                                <!-- 未登录提示 -->
                                <div class="login-to-vote text-center p-3">
                                    <p>登录后才能参与投票</p>
                                    <a href="{{ url_for('login') }}" class="btn login-btn">登录</a>
                                </div>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- 评论区 -->
    <div class="comments-section mt-4">
        <h5 class="section-title">评论 <span class="comments-count">{{ comments|length }}</span></h5>
        
        <!-- 添加评论表单 -->
        {% if 'loggedin' in session %}
            <div class="comment-form mb-4">
                <form id="commentForm">
                    <div class="d-flex">
                        <!-- 当前用户头像 -->
                        {% if current_user.profile_image %}
                            <img src="{{ url_for('get_profile_image', filename=current_user.profile_image) }}" class="comment-avatar" alt="{{ current_user.username }}">
                        {% else %}
                            <div class="comment-avatar-placeholder">
                                {{ current_user.username[0]|upper }}
                            </div>
                        {% endif %}
                        
                        <div class="comment-input-container">
                            <input type="text" name="content" class="form-control comment-input" placeholder="写下你的评论..." required>
                            <input type="hidden" name="post_id" value="{{ post.post_id }}">
                            <button type="button" class="btn comment-submit-btn" id="submitComment">发送</button>
                        </div>
                    </div>
                </form>
                <div id="commentAlert" class="alert alert-dismissible fade mt-2" role="alert" style="display: none;">
                    <span id="comment-alert-message"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            </div>
        {% else %}
            <div class="login-to-comment mb-4">
                <a href="{{ url_for('login') }}">登录后发表评论</a>
            </div>
        {% endif %}
        
        <!-- 评论列表 -->
        <div class="comments-list" id="commentsContainer">
            {% if comments %}
                {% for comment in comments %}
                    <div class="comment-item" id="comment-{{ comment.comment_id }}">
                        <div class="d-flex">
                            <!-- 评论者头像 -->
                            {% if comment.profile_image %}
                                <img src="{{ url_for('get_profile_image', filename=comment.profile_image) }}" class="comment-avatar" alt="{{ comment.username }}">
                            {% else %}
                                <div class="comment-avatar-placeholder">
                                    {{ comment.username[0]|upper }}
                                </div>
                            {% endif %}
                            
                            <div class="comment-content">
                                <div class="comment-header">
                                    <span class="comment-username">{{ comment.username }}</span>
                                    <span class="comment-time">{{ comment.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                                </div>
                                <div class="comment-text whitespace-pre-wrap">{{ comment.content }}</div>
                                <div class="comment-actions">
                                    <button class="btn comment-like-btn like-comment-btn" data-comment-id="{{ comment.comment_id }}">
                                        <i class="bi bi-heart"></i> <span class="like-count">{{ comment.likes }}</span>
                                    </button>
                                    
                                    {% if 'loggedin' in session and current_user.user_id == comment.user_id %}
                                        <button class="btn comment-delete-btn delete-comment-btn" data-comment-id="{{ comment.comment_id }}">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="no-comments" id="noCommentsMessage">
                    <div class="empty-icon">
                        <i class="bi bi-chat-dots"></i>
                    </div>
                    <p>还没有评论，快来抢沙发吧~</p>
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- 图片查看模态框 -->
    <div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <img src="" class="img-fluid" id="modalImage">
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* 小红书风格样式 */
    :root {
        --xhs-primary: #ff2442;
        --xhs-light: #fff6f7;
        --xhs-secondary: #ff8196;
        --xhs-dark: #333333;
        --xhs-gray: #999999;
        --xhs-light-gray: #f8f8f8;
        --xhs-border: #efefef;
    }
    
    .post-detail-container {
        max-width: 800px;
        padding-bottom: 50px;
    }
    
    .back-link {
        color: var(--xhs-dark);
        font-size: 15px;
    }
    
    .post-card {
        background-color: white;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
        padding: 20px;
        margin-bottom: 20px;
    }
    
    /* 用户信息样式 */
    .user-avatar, .user-avatar-placeholder {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
    }
    
    .user-avatar-placeholder {
        background-color: var(--xhs-light-gray);
        color: var(--xhs-gray);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
    }
    
    .username {
        font-weight: 600;
        font-size: 15px;
        color: var(--xhs-dark);
    }
    
    .post-time {
        font-size: 12px;
        color: var(--xhs-gray);
    }
    
    .follow-btn {
        background-color: var(--xhs-primary);
        color: white;
        border-radius: 20px;
        font-size: 13px;
        padding: 4px 12px;
    }
    
    .follow-btn:hover {
        background-color: #e61e39;
        color: white;
    }
    
    .share-btn {
        background-color: var(--xhs-light-gray);
        color: var(--xhs-dark);
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
    }
    
    .share-btn:hover {
        background-color: #e8e8e8;
    }
    
    /* 帖子内容样式 */
    .post-title {
        font-weight: 600;
        color: var(--xhs-dark);
        margin-top: 15px;
    }
    
    .post-text {
        font-size: 15px;
        line-height: 1.7;
        color: #505050;
    }
    
    .whitespace-pre-wrap {
        white-space: pre-wrap;
    }
    
    /* 图片样式 */
    .post-images {
        margin: 0 -20px 20px;
    }
    
    .single-image img {
        width: 100%;
        max-height: 500px;
        object-fit: contain;
        cursor: pointer;
    }
    
    .swiper {
        width: 100%;
        height: 400px;
    }
    
    .swiper-slide {
        text-align: center;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    
    .swiper-slide img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        cursor: pointer;
    }
    
    /* 投票样式 */
    .vote-section {
        background-color: var(--xhs-light-gray);
        border-radius: 10px;
        padding: 20px;
    }
    
    .vote-title {
        font-weight: 600;
        font-size: 16px;
        margin-bottom: 15px;
    }
    
    /* PK投票样式 */
    .pk-options-row {
        display: flex;
        align-items: center;
        position: relative;
        height: 80px;
    }
    
    .pk-option {
        flex: 1;
        height: 100%;
        background-color: white;
        border-radius: 8px;
        position: relative;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .pk-option:hover {
        transform: translateY(-2px);
        box-shadow: 0 3px 10px rgba(0,0,0,0.08);
    }
    
    .pk-option.selected {
        border: 2px solid var(--xhs-primary);
    }
    
    .pk-option-content {
        padding: 10px;
        text-align: center;
        position: relative;
        z-index: 2;
    }
    
    .pk-option-title {
        font-weight: 500;
        font-size: 15px;
        margin-bottom: 5px;
    }
    
    .pk-option-percent {
        font-weight: 600;
        font-size: 18px;
        color: var(--xhs-primary);
    }
    
    .pk-vote-count {
        font-size: 12px;
        color: var(--xhs-gray);
    }
    
    .pk-option-bar {
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        background-color: rgba(255, 36, 66, 0.1);
        z-index: 1;
        transition: width 1s ease-out;
    }
    
    .pk-vs {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background-color: var(--xhs-primary);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        z-index: 3;
        margin: 0 -18px;
    }
    
    /* 常规投票样式 */
    .vote-option {
        background-color: white;
        border-radius: 8px;
        padding: 12px 15px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .vote-option:hover {
        background-color: #f5f5f5;
    }
    
    .vote-option input[type="radio"],
    .vote-option input[type="checkbox"] {
        margin-right: 10px;
    }
    
    .vote-option label {
        cursor: pointer;
        font-size: 15px;
        width: 100%;
    }
    
    .vote-result-item {
        margin-bottom: 15px;
    }
    
    .vote-result-item.selected .vote-option-title {
        font-weight: 600;
    }
    
    .vote-result-item.selected .progress-bar {
        background-color: var(--xhs-primary);
    }
    
    .vote-option-title {
        font-size: 14px;
    }
    
    .vote-percent {
        font-size: 14px;
        color: var(--xhs-primary);
        font-weight: 500;
    }
    
    .progress {
        height: 8px;
        border-radius: 4px;
        background-color: #e9e9e9;
    }
    
    .progress-bar {
        background-color: #aaaaaa;
        transition: width 1s ease-out;
    }
    
    .vote-btn {
        background-color: var(--xhs-primary);
        color: white;
        border: none;
        border-radius: 20px;
        padding: 6px 20px;
        font-size: 14px;
    }
    
    .vote-btn:hover {
        background-color: #e61e39;
        color: white;
    }
    
    .revote-btn {
        color: var(--xhs-primary);
        background-color: transparent;
        border: 1px solid var(--xhs-primary);
        border-radius: 15px;
        font-size: 12px;
        padding: 2px 10px;
    }
    
    .login-btn {
        background-color: var(--xhs-primary);
        color: white;
        border-radius: 20px;
        font-size: 14px;
        padding: 5px 20px;
    }
    
    /* 评论区样式 */
    .comments-section {
        background-color: white;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
        padding: 20px;
    }
    
    .section-title {
        font-weight: 600;
        font-size: 16px;
        margin-bottom: 20px;
        color: var(--xhs-dark);
    }
    
    .comments-count {
        color: var(--xhs-gray);
        font-weight: normal;
    }
    
    .comment-avatar, .comment-avatar-placeholder {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        object-fit: cover;
    }
    
    .comment-avatar-placeholder {
        background-color: var(--xhs-light-gray);
        color: var(--xhs-gray);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
    }
    
    .comment-input-container {
        flex: 1;
        margin-left: 10px;
        position: relative;
    }
    
    .comment-input {
        border-radius: 20px;
        padding-right: 60px;
        border: 1px solid #e0e0e0;
    }
    
    .comment-input:focus {
        box-shadow: none;
        border-color: var(--xhs-primary);
    }
    
    .comment-submit-btn {
        position: absolute;
        right: 5px;
        top: 50%;
        transform: translateY(-50%);
        background-color: var(--xhs-primary);
        color: white;
        border-radius: 20px;
        padding: 3px 12px;
        font-size: 13px;
    }
    
    .login-to-comment {
        text-align: center;
        padding: 15px;
        background-color: var(--xhs-light-gray);
        border-radius: 8px;
    }
    
    .login-to-comment a {
        color: var(--xhs-primary);
        text-decoration: none;
    }
    
    .comment-item {
        padding: 15px 0;
        border-bottom: 1px solid var(--xhs-border);
    }
    
    .comment-item:last-child {
        border-bottom: none;
    }
    
    .comment-content {
        flex: 1;
        margin-left: 10px;
    }
    
    .comment-header {
        margin-bottom: 5px;
    }
    
    .comment-username {
        font-weight: 500;
        font-size: 14px;
        color: var(--xhs-dark);
    }
    
    .comment-time {
        font-size: 12px;
        color: var(--xhs-gray);
        margin-left: 8px;
    }
    
    .comment-text {
        font-size: 14px;
        line-height: 1.5;
        margin-bottom: 8px;
    }
    
    .comment-actions {
        display: flex;
        align-items: center;
    }
    
    .comment-like-btn, .comment-delete-btn {
        background: none;
        border: none;
        color: var(--xhs-gray);
        font-size: 12px;
        padding: 0;
        margin-right: 15px;
    }
    
    .comment-like-btn:hover {
        color: var(--xhs-primary);
    }
    
    .comment-delete-btn:hover {
        color: #dc3545;
    }
    
    .no-comments {
        text-align: center;
        padding: 40px 0;
        color: var(--xhs-gray);
    }
    
    .empty-icon {
        font-size: 40px;
        margin-bottom: 10px;
        opacity: 0.3;
    }
    
    /* 添加到现有的样式部分 */
    .follow-btn.followed {
        background-color: #e0e0e0;
        color: #333333;
    }
    
    .follow-btn.followed:hover {
        background-color: #ff6b6b;
        color: white;
    }
    
    .follow-btn.followed:hover:before {
        display: inline;
    }
    
    .follow-btn.followed:hover i,
    .follow-btn.followed:hover span {
        display: none;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 图片模态框功能
        const imageModal = document.getElementById('imageModal');
        if (imageModal) {
            imageModal.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;
                const imgSrc = button.getAttribute('data-bs-img');
                document.getElementById('modalImage').src = imgSrc;
            });
        }
        
        // 初始化轮播图 (如果有Swiper库)
        if (typeof Swiper !== 'undefined' && document.querySelector('.post-swiper')) {
            new Swiper('.post-swiper', {
                pagination: {
                    el: '.swiper-pagination',
                    clickable: true
                }
            });
        }
        
        // 显示提示信息
        function showAlert(elementId, message, type = 'success') {
            const alertEl = document.getElementById(elementId);
            const messageEl = alertEl.querySelector('span');
            
            alertEl.classList.remove('alert-success', 'alert-danger', 'alert-warning');
            alertEl.classList.add(`alert-${type}`);
            alertEl.classList.add('show');
            messageEl.textContent = message;
            alertEl.style.display = 'block';
            
            // 3秒后自动隐藏
            setTimeout(() => {
                alertEl.classList.remove('show');
                setTimeout(() => {
                    alertEl.style.display = 'none';
                }, 300);
            }, 3000);
        }
        
        // ============ PK 投票功能 ============
        const pkOptions = document.querySelectorAll('.pk-option');
        const pkSelectedOption = document.getElementById('pk-selected-option');
        const pkVoteBtn = document.getElementById('pk-vote-btn');
        
        if (pkOptions.length > 0 && pkSelectedOption && pkVoteBtn) {
            // PK选项点击事件
            pkOptions.forEach(option => {
                option.addEventListener('click', function() {
                    // 移除其他选项的选中状态
                    pkOptions.forEach(opt => opt.classList.remove('active'));
                    // 添加当前选项的选中状态
                    this.classList.add('active');
                    // 设置选中的选项ID
                    pkSelectedOption.value = this.getAttribute('data-option-id');
                    // 启用投票按钮
                    pkVoteBtn.disabled = false;
                });
            });
            
            // PK投票提交
            pkVoteBtn && pkVoteBtn.addEventListener('click', function() {
                const formData = new FormData(document.getElementById('pkVoteForm'));
                
                // 禁用按钮，防止重复提交
                this.disabled = true;
                this.textContent = '提交中...';
                
                fetch('/api/vote', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAlert('vote-alert', data.message, 'success');
                        
                        // 更新投票结果UI
                        const options = data.data.options;
                        const totalVotes = data.data.total_votes;
                        const userVoted = data.data.user_voted_options;
                        
                        // 显示百分比和票数
                        pkOptions.forEach((optionEl, index) => {
                            const option = options[index];
                            const optionId = parseInt(optionEl.getAttribute('data-option-id'));
                            const isSelected = userVoted.includes(optionId);
                            
                            // 更新选中状态
                            if (isSelected) {
                                optionEl.classList.add('selected');
                            }
                            
                            // 更新百分比和票数
                            const percentEl = optionEl.querySelector('.pk-option-percent');
                            const countEl = optionEl.querySelector('.pk-vote-count');
                            const barEl = optionEl.querySelector('.pk-option-bar');
                            
                            percentEl.textContent = `${option.percent}%`;
                            countEl.textContent = `(${option.vote_count}票)`;
                            percentEl.style.display = 'block';
                            countEl.style.display = 'block';
                            
                            // 动画显示进度条
                            setTimeout(() => {
                                barEl.style.width = `${option.percent}%`;
                            }, 100);
                        });
                        
                        // 隐藏投票按钮
                        pkVoteBtn.style.display = 'none';
                    } else {
                        showAlert('vote-alert', data.message, 'danger');
                        this.disabled = false;
                        this.textContent = '投票';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('vote-alert', '投票失败，请稍后重试', 'danger');
                    this.disabled = false;
                    this.textContent = '投票';
                });
            });
        }
        
        // ============ 常规投票功能 ============
        const submitNormalVoteBtn = document.querySelector('.submit-normal-vote-btn');
        const submitRevoteBtn = document.querySelector('.submit-revote-btn');
        
        // 常规投票提交
        if (submitNormalVoteBtn) {
            submitNormalVoteBtn.addEventListener('click', function() {
                const formData = new FormData(document.getElementById('normalVoteForm'));
                
                // 禁用按钮，防止重复提交
                this.disabled = true;
                this.textContent = '提交中...';
                
                fetch('/api/vote', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAlert('vote-alert', data.message, 'success');
                        
                        // 更新投票结果UI
                        updateVoteResults(data.data);
                        
                        // 显示结果，隐藏表单
                        document.getElementById('normalVoteForm').style.display = 'none';
                        document.getElementById('vote-results').style.display = 'block';
                    } else {
                        showAlert('vote-alert', data.message, 'danger');
                        this.disabled = false;
                        this.textContent = '投票';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('vote-alert', '投票失败，请稍后重试', 'danger');
                    this.disabled = false;
                    this.textContent = '投票';
                });
            });
        }
        
        // 关注/取消关注功能
        const followBtn = document.querySelector('.follow-btn');
        
        if (followBtn) {
            followBtn.addEventListener('click', function() {
                const userId = this.getAttribute('data-user-id');
                const formData = new FormData();
                formData.append('user_id', userId);
                
                // 禁用按钮，防止重复点击
                this.disabled = true;
                
                fetch('/api/follow', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 更新按钮文本和样式
                        if (data.data.is_following) {
                            this.innerHTML = '<i class="bi bi-check"></i> 已关注';
                            this.classList.add('followed');
                        } else {
                            this.innerHTML = '<i class="bi bi-plus"></i> 关注';
                            this.classList.remove('followed');
                        }
                        
                        // 显示成功消息
                        showAlert('vote-alert', data.message, 'success');
                    } else {
                        showAlert('vote-alert', data.message, 'danger');
                    }
                    this.disabled = false;
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('vote-alert', '操作失败，请稍后重试', 'danger');
                    this.disabled = false;
                });
            });
        }
    });
</script>
{% endblock %}